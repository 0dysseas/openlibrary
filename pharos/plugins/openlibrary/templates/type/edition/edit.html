$def with (page, action=None, title=None)

$ _t = _.get_namespace('/type/edition')
$ _ = _.get_namespace('/mode/edit')

$ title = title or (str(_.editing) + ' ' + page.title)
 
$var title: $title

$add_javascript('/static/js/jquery/freebase.suggest.js')
$add_javascript('/static/js/jquery/freebase.controls.js')
$add_javascript('/static/js/jquery/freebase.select.js')


<script type="text/javascript">
function add_row(name) {
    var tbody = \$("#tbody_" + name);
    var n = tbody.children().length;

    var row = \$("tr:last", tbody);
    var newrow = row.clone();
    tbody.append(newrow);

    \$("td:last", row).html("");

    \$("td:first", newrow).html("");
    \$("input", newrow).attr("name", name + "#" + n);
    \$("input", newrow).attr("value", "");
}

jQuery(function(\$) {
    \$("#table_toc button.plus").bind("click", function(e) {
        \$("div#log").append(this + "<br/>");
    });
});

</script>

<div id="log">
</div>

<form method="POST" action="$(action or '')">

    <div id="slickbox" style="overflow: hidden">
        $:macros.TypeChanger(page.type)
    </div>

    <input type="hidden" name="type.key" value="/type/edition"/>
    <!-- WIKI EDIT SECTION -->
    <div id="biblio-form-body">    
        <table cellspacing="0" cellpadding="0" border="0" width="100%">
        <tr>
            <td valign="top">
                <div id="header">               
                    <span class="pretitle">$_.pretitle:<br /></span>             
                    <div id="title">$page.title</div>            
                </div>
                
                <!-- begin left table -->
                <table cellspacing="0" cellpadding="0" border="0" width="100%">
                    <tr>
                       <td valign="top" colspan="3" height="8"></td>
                    </tr>
                    
                    $:macros.EditionEditRow(page, 'title_prefix', True)
                    $:macros.EditionEditRow(page, 'title', True)
                    $:macros.EditionEditRow(page, 'subtitles', False)
                    $:macros.EditionEditRow(page, 'by_statements', False)
                    $:macros.EditionEditRow(page, 'authors', False)
                    $:macros.EditionEditRow(page, 'contributors', False)

                    <tr><td valign="top" colspan="4" class="vertspace24"></td></tr>

                    $:macros.EditionEditRow(page, 'publish_date', True)
                    $:macros.EditionEditRow(page, 'publishers', False)
                    $:macros.EditionEditRow(page, 'publish_places', False)

                    $:macros.EditionEditRow(page, 'series', False)
                    $:macros.EditionEditRow(page, 'edition_name', True)
                    $:macros.EditionEditRow(page, 'language', True)
                    $:macros.EditionEditRow(page, 'work_titles', False)

                    <tr><td valign="top" colspan="3" height="22"></td></tr>

                    <tr>
                        <td valign="middle" class="formheader">$_t.pagination</td>
	                <td>
		            <table cellspacing="0" cellpadding="0" border="0">
                                <tr>
		                    <td valign="top"><input type="text" name="language_code" value="$page['pagination']"  size="8" /></td>
		                    <td valign="middle" class="formheader">$_t.size</td>
		                    <td valign="top"><input type="text" name="language_code" value="$page['physical_dimensions']" size="10" /></td>
		                    <td valign="middle" class="formheader">$_t.physical_format</td>
		                    <td valign="top"><input type="text" name="language" value="$page['physical_format']" size="10" /></td>
		                    <td valign="middle" class="formheader">$_t.pages</td>
		                    <td valign="top" width="100%"><input type="text" name="language_code" value="$page['number_of_pages']"  size="8" /></td>
		                </tr>
                            </table>
	                </td>
                    </tr>



                    <!-- ADDITIONAL METADATA -->
                    <tr><td valign="top" colspan="4" class="vertspace24"></td></tr>

                    <!-- description -->
                    <tr><td valign="top" colspan="4" class="formheader-top">$_t.description</td></tr>
                    <tr><td valign="top" colspan="4" class="formheader" width="100%"><textarea name="description" rows="6" cols="">$page.description</textarea></td></tr>                    
                
                    <!-- notes -->
                    <tr><td valign="top" colspan="4" class="formheader-top">$_t.notes</td></tr>
                    <tr><td valign="top" colspan="4" class="formheader" width="100%"><textarea name="notes" rows="6" cols="">$page.notes</textarea></td></tr>                    
                    
                    <tr> <!-- begin table of contents -->
                        <td valign="top" colspan="4" width="100%" class="formheader">
<!--                            <table id="table_toc" cellspacing="0" cellpadding="0" border="0" class="formheader-toc" width="100%">
                                <tr>
                                    <td colspan="4" valign="middle" class="formheader-identifier-left">$_t.table_of_contents</td>
                                </tr>
                                $ toc = page.table_of_contents or [""]

                                $for i, v in enumerate(toc):
                                    <tr>    
                                        <td valign="top" class="formbuttons-identifier">
                                            <button type="button" class="control up" name="$_.up" title="$_.up">
                                                <img src="/static/images/arrow.up.gif" alt="$_.up" width="18" height="18" />
                                            </button>
                                            <button type="button" class="control down" name="$_.down" title="$_.down">
                                                <img src="/static/images/arrow.down.gif" alt="$_.down" width="18" height="18" />
                                            </button>

                                        </td>
                                        <td colspan="4" valign="top" class="formfield" width="100%">
                                            <input type="text" class="identifier" name="toc0" value="$v" style="width: 100%" />
                                        </td>
                                        <td valign="top" class="formbuttons-identifier">
                                            $if i == len(toc) - 1:
                                                <button type="button" class="control plus" name="+" title="+">
                                                    <img src="/static/images/+.gif" alt="+" width="18" height="18" />
                                                </button>
                                        </td>
                                    </tr>
                            </table> -->

                    $:macros.EditionEditRow(page, "table_of_contents", unique=False, right=False)

                        </td>
                    </tr> <!-- end table of contents -->
                </table> <!-- end left table -->
            </td>
            <td valign="top" class="form-margin">
                <br />
                $:macros.ImageUploader(page.key.replace('/b/', ''), 'coverimage', page['coverimage'])
                <br />
 
               <!-- begin right table -->
                <table cellspacing="0" cellpadding="0" border="0">
                    <tr>
                        <td valign="top" colspan="4" width="100%" class="vertspace9">

                    		<br /><br /><br />
                            </td>
                    </tr>

                    $:macros.EditionEditRow(page, "dewry_decimal_class", unique=True, right=True)
                    $:macros.EditionEditRow(page, "lc_classifications", unique=False, right=True)
                    $:macros.EditionEditRow(page, "isbn_10", unique=False, right=True)
                    $:macros.EditionEditRow(page, "isbn_13", unique=False, right=True)
                    $:macros.EditionEditRow(page, "lccn", unique=True, right=True)
                    $:macros.EditionEditRow(page, "ocaid", unique=True, right=True)
                    $:macros.EditionEditRow(page, "oclc_numbers", unique=False, right=True)

                    <tr><td valign="middle" class="vertspace24"></td></tr>

                    $:macros.EditionEditRow(page, "subjects", unique=False, right=True)
                    $:macros.EditionEditRow(page, "genres", unique=False, right=True)
                </table>
                <!-- end right table -->

                <br />
            </td>
        </tr>
        </table>
            
        <!-- edit summary and buttons -->
                    $:macros.EditButtons(page)
    </div>
</form>

$if page.key:
    <div class="copyright-footer">
        <div style="float: right; padding-bottom: 9px;">
            <a href="/clonebook?key=$page.key">$_.clone_book</a> &rarr;
        </div>
    </div>