$def with (work, edition_key=None, show_lists=True)

$code:
    def get_seed_info():
      if work.key.startswith("/subjects/"):
          seed = work.key.split("/")[-1]
          if seed.split(":")[0] not in ["place", "person", "time"]:
              seed = "subject:" + seed
          seed = seed.replace(",", "_").replace("__", "_")
          seed_type = "subject"
          title = work.name
      else:
          seed = {"key": work.key}
          if work.key.startswith("/authors/"):
              seed_type = "author"
              title = work.get('name', 'name missing')
          elif work.key.startswith("/works"):
              seed_type = "work"
              title = work.get("title", "untitled")
          else:
              seed_type = "edition"
              title = work.get("title", "untitled")
      return seed, seed_type, title

    def get_list_data(list, include_cover_url=True):
      d = storage({
          "name": list.name or "",
          "key": list.key,
          "active": list.has_seed(seed),
      })
      if include_cover_url:
          cover = list.get_cover() or list.get_default_cover()
          d['cover_url'] = cover and cover.url("S") or "/images/icons/avatar_book-sm.png"
      owner = list.get_owner()
      d['owner'] = storage(displayname=owner.displayname or "", key=owner.key)
      return d

    def get_user_lists():
      lists = ctx.user and ctx.user.get_lists(sort=True) or []
      return [get_list_data(list, include_cover_url=True) for list in lists]

$ username = ctx.user and ctx.user.key.split('/')[-1]
$ seed, seed_type, title = get_seed_info()
$ lists = get_user_lists()
$ users_work_read_status = work.get_users_read_status(username) if work and username else None

<div class="dropit">
  $if edition_key:
    <div class="dropper on edition-page-lists-dropdown">
  $else:
    <div class="dropper on">
  $if work.key:
    <div class="log-work">
      <form class="readingLog" method="POST" action="$(work.key)/bookshelves.json">
        $if users_work_read_status == 3:
            $ message = _("Already Read")
        $elif users_work_read_status == 2:
            $ message = _("Currently Reading")
        $else:
            $ message = _("Want to Read")
        $if users_work_read_status:
          <input type="hidden" name="action" value="remove"/>
          <input type="hidden" name="redir" value="true"/>
          <input type="hidden" name="bookshelf_id" value="$(users_work_read_status)"/>
          <button class="book-progress-btn want-to-read activated"
                  type="submit">
            <span class="activated-check">âœ“</span> $(message)
          </button>
        $else:
          <input type="hidden" name="action" value="add"/>
          <input type="hidden" name="redir" value="true"/>
          <input type="hidden" name="bookshelf_id" value="1"/>
          <button class="book-progress-btn want-to-read unactivated"
                  type="submit">
            $(message)
          </button>

        $if edition_key:
          <input type="hidden" id="edition_id" name="edition_id" value="$(edition_key)"/>
      </form>
      $if users_work_read_status:
        <a href="javascript:;" class="dropclick dropclick-activated">
          <div class="arrow arrow-activated"></div>
        </a>
      $else:
        <a href="javascript:;" class="dropclick dropclick-unactivated">
          <div class="arrow arrow-unactivated"></div>
        </a>
    </div>
    <div class="dropdown">
      <div class="read-statuses">
        $if users_work_read_status == 2 or users_work_read_status == 3:
          <form class="readingLog" method="POST" action="$(work.key)/bookshelves.json?debug=true">
            <input type="hidden" name="action" value="add"/>
            <input type="hidden" name="redir" value="true"/>
            <input type="hidden" name="bookshelf_id" value="1"/>
            $if edition_key:
              <input type="hidden" id="edition_id" name="edition_id" value="$(edition_key)"/>
            <button class="nostyle-btn" type="submit">$_('Want to Read')</button>
          </form>

        $if users_work_read_status != 2:
          <form class="readingLog" method="POST" action="$(work.key)/bookshelves.json?debug=true">
            <input type="hidden" name="action" value="add"/>
            <input type="hidden" name="redir" value="true"/>
            <input type="hidden" name="bookshelf_id" value="2"/>
            $if edition_key:
              <input type="hidden" id="edition_id" name="edition_id" value="$(edition_key)"/>
            <button class="nostyle-btn" type="submit">$('Currently Reading')</button>
          </form>

        $if users_work_read_status != 3:
          <form class="readingLog" method="POST" action="$(work.key)/bookshelves.json?debug=true">
            <input type="hidden" name="action" value="add"/>
            <input type="hidden" name="redir" value="true"/>
            <input type="hidden" name="bookshelf_id" value="3"/>
            $if edition_key:
              <input type="hidden" id="edition_id" name="edition_id" value="$(edition_key)"/>
            <button class="nostyle-btn" type="submit">$_('Already Read')</button>
          </form>
      </div>

      $if show_lists:
        <div class="reading-lists">
          <p class="reading-list-title">$_('My Reading Lists ')</p>
          <div class="my-lists">
              <p class="list">
                <label class="create checkboxes" for="x"><input type="checkbox" onclick="if(this.checked){myFunction()}else{myFunction1()}" id="work-check"/> <span>Use this Work</span></label>  
              </p>
            $for i, list in enumerate(lists):
              $if not list.active:
                <p class="list"><a href="$list.key" class="add-to-list" id="list_$i">$list.name</a></p>
          </div>
          <p class="create"><a href="javascript:;" id="create-new-list">$_('Create a new list')</a>
            <a aria-controls="addList"
              class="hidden listClick dialog--open"></a>
          </p>
        </div>
    </div>
  $else:
      $if username:
        <div class="reading-lists">
          <a href="javascript:;" class="dropclick">
            <h3>$_('Add to List')</h3>
            <div class="arrow arrow-activated"></div>
          </a>
          <div class="dropdown">
             <div class="my-lists">
              $for i, list in enumerate(lists):
                $if not list.active:
                  <p class="list"><a href="$list.key" class="add-to-list" id="list_$i">$list.name</a></p>
            </div>
            <p class="create"><a href="javascript:;" id="create-new-list">$_('Create a new list')</a>
            </p>
          </div>
        </div>

      $else:
        <a href="/account/login?redir=$page.url()" class="dropclick plain">
          <h3>$('Add to List')</h3>
          <div class="arrow"></div>
        </a>
</div>
</div>
